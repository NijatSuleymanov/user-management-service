# User Management Service

A comprehensive Spring Boot REST API for managing users with full CRUD operations, exception handling, logging, and Docker containerization.

## Description

The User Management Service is a production-ready microservice built with Spring Boot 3+ that provides RESTful API endpoints for user management. The service includes:

- **User CRUD Operations** - Create, read, update, and delete users
- **Robust Exception Handling** - Centralized error handling with meaningful HTTP status codes
- **Comprehensive Logging** - Request tracking, error logging, and audit trails
- **Database Persistence** - PostgreSQL integration with Hibernate ORM
- **Docker Support** - Fully containerized application with Docker Compose
- **Environment Configuration** - Flexible configuration using environment variables
- **Input Validation** - Request validation with detailed error messages

## Tech Stack

- **Language:** Kotlin
- **Framework:** Spring Boot 3.5.7
- **ORM:** Hibernate 6.6.33
- **Database:** PostgreSQL 16
- **Build Tool:** Gradle 8.14.3
- **Logging:** SLF4J with Logback
- **Container:** Docker & Docker Compose
- **JDK:** Eclipse Temurin 17

### Dependencies

```gradle
- spring-boot-starter-web (REST APIs)
- spring-boot-starter-data-jpa (Database ORM)
- spring-boot-starter-validation (Input validation)
- spring-boot-starter-actuator (Health checks)
- postgresql (Database driver)
- flyway (Database migrations)
- kotlin-stdlib (Kotlin runtime)
```

## Getting Started

### Prerequisites

- Docker & Docker Compose installed
- Git installed
- (Optional) JDK 17+ if running locally without Docker

### Quick Start with Docker

1. **Clone the repository:**
   ```bash
   git clone https://github.com/NijatSuleymanov/user-management-service.git
   cd user-management-service
   ```

2. **Create environment file:**
   ```bash
   cp .env.example .env
   ```

3. **Start the application:**
   ```bash
   docker-compose up -d
   ```

4. **Verify it's running:**
   ```bash
   curl http://localhost:8080/actuator/health
   ```

The application will be available at `http://localhost:8080`

### Local Setup (Without Docker)

1. **Install dependencies:**
   ```bash
   ./gradlew build
   ```

2. **Configure PostgreSQL:**
   - Ensure PostgreSQL 16 is running locally
   - Update database URL in `application.yaml`

3. **Run the application:**
   ```bash
   ./gradlew bootRun
   ```

## Environment Variables

Create a `.env` file in the project root using `.env.example` as a template:

```env
# Database Configuration
POSTGRES_DB=userdb
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres

# Spring Boot Application Configuration
SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/userdb
SPRING_DATASOURCE_USERNAME=postgres
SPRING_DATASOURCE_PASSWORD=postgres

# JPA Configuration
SPRING_JPA_HIBERNATE_DDL_AUTO=update
SPRING_JPA_SHOW_SQL=true
```

**Important:** Never commit the `.env` file to version control. The `.env` file is listed in `.gitignore` for security.

### Default Values

If no environment variables are set, the application uses:
- Database: `jdbc:postgresql://localhost:5432/userdb`
- Username: `postgres`
- Password: `postgres`

## Database Setup

### Automatic Setup (with Docker)

When using Docker Compose, the database is automatically created and initialized:

1. PostgreSQL container creates the `userdb` database
2. Hibernate automatically creates the `users` table on first run
3. All schema migrations are handled automatically

### Manual Setup (Local)

If running locally without Docker:

```sql
-- Create database
CREATE DATABASE userdb;

-- Connect to database
\c userdb;

-- Create users table (Hibernate will do this automatically)
-- Or run the application to let Hibernate generate the schema
```

### Database Schema

**Users Table:**

```sql
CREATE TABLE users (
    id BIGINT PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    name VARCHAR(255) NOT NULL,
    email VARCHAR(255) NOT NULL UNIQUE,
    phone VARCHAR(255),
    role VARCHAR(50) CHECK (role IN ('USER', 'ADMIN')),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE UNIQUE INDEX uk_users_email ON users(email);
```

## API Endpoints

### Base URL
```
http://localhost:8080/api/users
```

### 1. Create User

**Request:**
```http
POST /api/users
Content-Type: application/json

{
    "name": "John Doe",
    "email": "john@example.com",
    "phone": "1234567890"
}
```

**Response (201 Created):**
```json
{
    "timestamp": "2025-11-18T14:25:14.724087954",
    "status": 201,
    "message": "User created successfully",
    "data": {
        "id": 1,
        "name": "John Doe",
        "email": "john@example.com",
        "phone": "1234567890",
        "role": "USER"
    },
    "error": null
}
```

### 2. Get All Users

**Request:**
```http
GET /api/users
```

**Response (200 OK):**
```json
{
    "timestamp": "2025-11-18T14:26:59.265890626",
    "status": 200,
    "message": "Users retrieved successfully",
    "data": [
        {
            "id": 1,
            "name": "John Doe",
            "email": "john@example.com",
            "phone": "1234567890",
            "role": "USER"
        }
    ],
    "error": null
}
```

### 3. Get User by ID

**Request:**
```http
GET /api/users/1
```

**Response (200 OK):**
```json
{
    "timestamp": "2025-11-18T14:27:06.582395469",
    "status": 200,
    "message": "User retrieved successfully",
    "data": {
        "id": 1,
        "name": "John Doe",
        "email": "john@example.com",
        "phone": "1234567890",
        "role": "USER"
    },
    "error": null
}
```

### 4. Update User

**Request:**
```http
PUT /api/users/1
Content-Type: application/json

{
    "name": "John Smith",
    "email": "john@example.com",
    "phone": "9999999999"
}
```

**Response (200 OK):**
```json
{
    "timestamp": "2025-11-18T14:27:15.612119714",
    "status": 200,
    "message": "User updated successfully",
    "data": {
        "id": 1,
        "name": "John Smith",
        "email": "john@example.com",
        "phone": "9999999999",
        "role": "USER"
    },
    "error": null
}
```

### 5. Delete User

**Request:**
```http
DELETE /api/users/1
```

**Response (204 No Content):**
```
HTTP 204 No Content
```

## Deployment

The application is **live and deployed** on Render.

### ğŸŒ Production Environment

**Deployment Platform:** [Render](https://render.com) (Cloud Application Platform)

**Production Base URL:**
```
https://user-management-service-1-1t69.onrender.com
```

**Status:** âœ… Running and accessible

### ğŸ§ª Example Working Endpoint

Test the deployed application right now:

```bash
â¡ GET â€” https://user-management-service-1-1t69.onrender.com/api/users
```

Response:
```json
{
    "timestamp": "2025-11-19T10:30:00.000000000",
    "status": 200,
    "message": "Users retrieved successfully",
    "data": [],
    "error": null
}
```

### ğŸ“‹ Live API Endpoints

All endpoints are available on the deployed application:

| Method | Endpoint | Description |
|--------|----------|-------------|
| `GET` | `/` | Service welcome message |
| `GET` | `/actuator/health` | Health check status |
| `POST` | `/api/users` | Create a new user |
| `GET` | `/api/users` | Retrieve all users |
| `GET` | `/api/users/{id}` | Get specific user by ID |
| `PUT` | `/api/users/{id}` | Update user details |
| `DELETE` | `/api/users/{id}` | Delete a user |

### ğŸ”— Quick Test Commands

```bash
# Check service status
curl https://user-management-service-1-1t69.onrender.com/

# Get all users
curl https://user-management-service-1-1t69.onrender.com/api/users

# Create a new user
curl -X POST https://user-management-service-1-1t69.onrender.com/api/users \
  -H "Content-Type: application/json" \
  -d '{"name":"John Doe","email":"john@example.com","phone":"1234567890"}'

# Get specific user
curl https://user-management-service-1-1t69.onrender.com/api/users/1

# Update user
curl -X PUT https://user-management-service-1-1t69.onrender.com/api/users/1 \
  -H "Content-Type: application/json" \
  -d '{"name":"Jane Doe","email":"jane@example.com","phone":"9876543210"}'

# Delete user
curl -X DELETE https://user-management-service-1-1t69.onrender.com/api/users/1
```

### âš™ï¸ Deployment Configuration

**Render Setup:**
- **Auto-deployment:** Enabled from GitHub main branch
- **Region:** US (default)
- **Database:** PostgreSQL on Render
- **Environment Variables:** Securely managed in Render dashboard
- **Health Checks:** Configured on `/actuator/health`
- **Restart Policy:** Automatic restart on crashes
- **Deployment Strategy:** Zero-downtime deployments

**Features:**
âœ… Automatic deployment on GitHub push
âœ… PostgreSQL database integration
âœ… Environment-based configuration
âœ… Health monitoring and auto-restart
âœ… Request logging and monitoring

## Logging

The application implements comprehensive logging for debugging, monitoring, and audit trails.

### Logging Architecture

**Logging Framework:** SLF4J + Logback

**Configuration Files:**
- `logback-spring.xml` - Logback configuration with appenders
- `application.yaml` - Spring Boot logging level configuration

### Log Levels

```yaml
root: INFO                                    # Global default level
com.example.user_management_service: DEBUG    # Application package
org.springframework.web: INFO                 # Spring Web
org.hibernate.SQL: DEBUG                      # SQL statements
org.hibernate.type.descriptor.sql: TRACE     # SQL parameters
```

### Logged Events

**Controller Layer (UserController):**
- API request entry/exit
- Request parameters and response status
- Example: `POST /api/users - Creating new user with email: john@example.com`

**Service Layer (UserServiceImpl):**
- Business logic execution
- Data creation/update/delete operations
- Duplicate detection warnings
- Example: `Creating new user with email: john@example.com`

**Exception Handler (GlobalExceptionHandler):**
- All caught exceptions
- Error codes and messages
- Request paths for audit trail
- Example: `ResourceNotFoundException - Message: User with id '99999' not found`

### Log Output

**Console Output:**
- Real-time logs in console during development
- Includes timestamp, level, logger name, and message

**File Output:**
- `logs/application.log` - All application logs
- `logs/error.log` - Error level logs only
- Rolling policy: 10MB file size, 30-day retention

### Example Log Entries

```log
2025-11-18T14:38:37.654Z INFO UserController - POST /api/users - Creating new user with email: logging@example.com
2025-11-18T14:38:37.654Z INFO UserServiceImpl - Creating new user with email: logging@example.com
2025-11-18T14:38:37.654Z DEBUG UserServiceImpl - Fetching user by email from database
2025-11-18T14:38:37.655Z INFO UserServiceImpl - User created successfully with id: 4, email: logging@example.com
2025-11-18T14:38:37.655Z INFO UserController - POST /api/users - User created successfully with id: 4
```

## Error Handling

The application implements centralized exception handling with meaningful HTTP status codes and detailed error messages.

### Error Response Format

```json
{
    "timestamp": "2025-11-18T14:24:56.801573753",
    "status": 404,
    "error": "Resource Not Found",
    "message": "User with id '9999' not found",
    "path": "/api/users/9999",
    "errorCode": "RESOURCE_NOT_FOUND"
}
```

### HTTP Status Codes

| Status | Code | Scenario |
|--------|------|----------|
| **201** | CREATED | User successfully created |
| **200** | OK | Successful GET, PUT operations |
| **204** | NO_CONTENT | Successful DELETE operation |
| **400** | BAD_REQUEST | Validation errors, invalid input |
| **404** | NOT_FOUND | Resource not found (user doesn't exist) |
| **409** | CONFLICT | Duplicate resource (email already exists) |
| **500** | INTERNAL_SERVER_ERROR | Unexpected server error |

### Exception Types

**1. ResourceNotFoundException (404)**
- User with specified ID not found
- Occurs during GET by ID, UPDATE, DELETE operations

**2. DuplicateResourceException (409)**
- User with same email already exists
- Occurs during CREATE or UPDATE with existing email

**3. ValidationException (400)**
- Input validation failed
- Invalid email format, missing required fields
- Response includes field-level error messages

**4. BusinessException (400)**
- Generic business logic error
- Includes error code for client handling

**Example Error Response - Validation:**
```json
{
    "timestamp": "2025-11-18T14:26:10.099244559",
    "status": 400,
    "error": "Validation Failed",
    "message": "User validation failed",
    "path": "/api/users",
    "fieldErrors": {
        "email": "Email must be valid"
    }
}
```

## Docker & Docker Compose

### Docker Setup

The application is fully containerized with multi-stage Docker builds for optimal image size.

**Dockerfile:**
```dockerfile
FROM eclipse-temurin:17-jdk
WORKDIR /app
COPY build/libs/user-management-service-0.0.1-SNAPSHOT.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "app.jar"]
```

### Docker Compose Configuration

**Services:**

1. **PostgreSQL Database (postgres:16-alpine)**
   - Container: `user-management-db`
   - Port: `5432:5432`
   - Environment: Username/password configured via `.env`
   - Health check: Validates database connectivity
   - Volume: Persistent data storage

2. **Spring Boot Application (user-management-service-app)**
   - Container: `user-management-app`
   - Port: `8080:8080`
   - Depends on: PostgreSQL (healthy status)
   - Environment: Database URL, credentials from `.env`

**Network:**
- Custom bridge network: `user-management-service_user-network`
- Allows service-to-service communication by hostname

**Volumes:**
- `postgres_data` - Persistent PostgreSQL data directory

### Docker Compose Commands

```bash
# Start containers in background
docker-compose up -d

# Stop containers
docker-compose down

# Rebuild and start (after code changes)
docker-compose up --build -d

# View logs
docker-compose logs -f app

# View database logs
docker-compose logs -f postgres

# Execute command in container
docker-compose exec app sh
```

### Important Notes

- **Version Warning:** The `version: '3.8'` attribute is obsolete in Docker Compose. This can be removed in future updates.
- **.dockerignore:** The `build/` directory is excluded by default in `.dockerignore` to prevent large images. This was fixed to include JAR files.
- **Environment Variables:** All sensitive data (passwords, URLs) should be in `.env` file, not hardcoded in YAML.

## Project Structure

```
user-management-service/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main/
â”‚   â”‚   â”œâ”€â”€ kotlin/com/example/user_management_service/
â”‚   â”‚   â”‚   â”œâ”€â”€ controller/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ UserController.kt
â”‚   â”‚   â”‚   â”œâ”€â”€ service/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ UserService.kt
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ impl/
â”‚   â”‚   â”‚   â”‚       â”œâ”€â”€ UserServiceImpl.kt
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ UserValidationServiceImpl.kt
â”‚   â”‚   â”‚   â”œâ”€â”€ repository/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ UserRepository.kt
â”‚   â”‚   â”‚   â”œâ”€â”€ entity/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ User.kt
â”‚   â”‚   â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ UserDTO.kt
â”‚   â”‚   â”‚   â”œâ”€â”€ mapper/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ UserMapper.kt
â”‚   â”‚   â”‚   â”œâ”€â”€ exception/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ GlobalExceptionHandler.kt
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ResourceNotFoundException.kt
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ DuplicateResourceException.kt
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ValidationException.kt
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ BusinessException.kt
â”‚   â”‚   â”‚   â”œâ”€â”€ response/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ApiResponse.kt
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ErrorResponse.kt
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ValidationErrorResponse.kt
â”‚   â”‚   â”‚   â””â”€â”€ UserManagementServiceApplication.kt
â”‚   â”‚   â””â”€â”€ resources/
â”‚   â”‚       â”œâ”€â”€ application.yaml
â”‚   â”‚       â”œâ”€â”€ logback-spring.xml
â”‚   â”‚       â””â”€â”€ static/
â”‚   â””â”€â”€ test/
â”œâ”€â”€ build.gradle.kts
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ .env.example
â”œâ”€â”€ .gitignore
â”œâ”€â”€ .dockerignore
â”œâ”€â”€ README.md (this file)
â””â”€â”€ gradle/wrapper/
```

## Authors

- **Developer:** Nijat Suleymanov
- **Email:** [snicat894@gmail.com]
- **GitHub:** [@NijatSuleymanov](https://github.com/NijatSuleymanov)

## License

This project is licensed under the MIT License - see the LICENSE file for details.

---

## Troubleshooting

### Docker Issues

**Port already in use:**
```bash
# Change ports in docker-compose.yml
# Or kill existing process:
lsof -i :8080
kill -9 <PID>
```

**Database connection failed:**
```bash
# Check PostgreSQL container is healthy
docker-compose ps

# View database logs
docker-compose logs postgres
```

### Application Issues

**Health check fails:**
```bash
# Check application logs
docker-compose logs app

# Verify environment variables
cat .env
```

**Validation errors:**
- Check email format (must be valid email)
- Check required fields (name, email)
- Check phone format (optional but must be valid if provided)

---

**Last Updated:** November 18, 2025
